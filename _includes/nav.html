{% comment %} Init call with current_depth, max_depth. Both are zero-based. {% endcomment %}

{% assign current_lvl_url_length = include.current_depth | plus: 2 %}
{% assign next_lvl_url_length = current_lvl_url_length | plus: 1 %}
{% assign max_url_length = include.max_depth | plus: 2 %}
{% assign base_url = include.base_url %}

{% if include.base_url == nil %}
    {% assign base_url = '/' %}
{% endif %}

<ul>
{% for node in site.pages %}
    {% assign node_url_parts = node.url | split: '/' %}
    {% assign filename = node_url_parts | last %}

    {% if node_url_parts.size == current_lvl_url_length and node.url contains base_url and filename != 'index.html' and filename contains 'html' %}
        <li class="page-link">
            <a href='{{node.url}}'>{{node.title}}</a>

            {% if next_lvl_url_length <= max_url_length %}
                {% assign node_base_url = node.url | replace: '.html' | append: '/' %}
                {% assign next_depth = include.current_depth | plus: 1 %}

                {% include nav.html current_depth=next_depth max_depth=include.max_depth base_url=node_base_url old_base_url=base_url %}

                {% comment %} Reverse recursion state: {% endcomment %}

                {% assign current_lvl_url_length = current_lvl_url_length | minus: 1 %}
                {% assign next_lvl_url_length = next_lvl_url_length | minus: 1 %}
                {% assign base_url = include.old_base_url %}
                {% if include.old_base_url == nil %}
                    {% assign base_url = '/' %}
                {% endif %}
            {% endif %}

        </li>
    {% endif %}
{% endfor %}
</ul>