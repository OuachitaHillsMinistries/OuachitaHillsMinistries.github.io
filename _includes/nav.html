{% comment %} Init call with base_url, max_depth (zero based). {% endcomment %}

{% assign base_url = include.lvl_base_url %}

{% if base_url == nil %}
  {% assign base_url = include.base_url %}
  {% assign lvl_base_url = include.base_url %}
{% endif %}
{% if base_url == nil %}
  {% assign base_url = '/' %}
  {% assign lvl_base_url = '/' %}
{% endif %}

{% if lvl_base_url == '/' %}
  {% assign current_lvl_url_length = 2 %}
{% else %}
  {% assign current_lvl_url_parts = lvl_base_url | split: '/' %}
  {% assign current_lvl_url_length = current_lvl_url_parts.size | plus: 1 %}
{% endif %}

{% assign next_lvl_url_length = current_lvl_url_length | plus: 1 %}
{% assign max_url_length = include.max_depth | plus: 2 %}

{% capture links %}
  {% for node in site.pages %}
  {% assign node_url_parts = node.url | split: '/' %}
  {% assign filename = node_url_parts | last %}

  {% if node_url_parts.size == current_lvl_url_length and node.url contains base_url and filename != 'index.html' and filename contains 'html' %}
  <li class="page-link">
    <a href='{{node.url}}'>{{node.title}}</a>
    {% if next_lvl_url_length <= max_url_length %}
      {% assign lvl_base_url = node.url | replace: '.html' | append: '/' %}

      {% include nav.html max_depth=include.max_depth base_url=base_url lvl_base_url=lvl_base_url %}

      {% comment %} Reverse recursion state: {% endcomment %}
      {% assign current_lvl_url_length = current_lvl_url_length | minus: 1 %}
      {% assign next_lvl_url_length = next_lvl_url_length | minus: 1 %}
      {% assign base_url = include.base_url %}
      {% if include.base_url == nil %}
        {% assign base_url = '/' %}
      {% endif %}
    {% endif %}
  </li>
  {% endif %}
  {% endfor %}
{% endcapture %}

{% assign links = links | strip %}

{% if links.size > 0 %}
<ul>{{ links }}</ul>
{% endif %}