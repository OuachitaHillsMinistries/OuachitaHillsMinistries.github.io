{% comment %} https://thinkshout.com/blog/2014/12/creating-dynamic-menus-in-jekyll/ {% endcomment %}

{% assign url_parts = page.url | split: '/' %}
{% assign url_parts_size = url_parts | size %}
{% assign rm = url_parts | last %}
{% assign base_url = page.url %}
{% if rm.size > 0 %}
    {% assign base_url = page.url | replace: rm %}
{% endif %}

<ul>
    {% for node in site.pages %}
        {% assign node_url_parts = node.url | split: '/' %}
        {% assign filename = node_url_parts | last %}
        {% if node_url_parts.size == 2 and filename != 'index.html' and filename contains 'html' %}

            {% assign node_base_url = node.url | replace: '.html' | append: '/' %}
            {% assign is_submenu = false %}
            {% for subnode in site.pages %}
                {% assign subnode_url_parts = subnode.url | split: '/' %}
                {% if subnode_url_parts.size == 3 and subnode.url contains node_base_url %}
                    {% assign is_submenu = true %}
                    {% break %}
                {% endif %}
            {% endfor %}

            <li class="page-link">
                <a href='{{node.url}}'>{{node.title}}</a>
                {% if is_submenu %}
                    <ul>
                        {% for subnode in site.pages %}
                            {% assign subnode_url_parts = subnode.url | split: '/' %}
                            {% if subnode_url_parts.size == 3 and subnode.url contains node_base_url %}
                                <li><a href="{{subnode.url}}">{{subnode.title}}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}
            </li>
        {% endif %}
    {% endfor %}
</ul>